#!/usr/bin/env python3
"""Pre-commit hook to run checks before allowing commits."""

import subprocess
import sys
from pathlib import Path


def run_command(cmd, description):
    """Run a command and return True if successful."""
    print(f"Running {description}...")
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
    
    if result.returncode != 0:
        print(f"❌ {description} failed!")
        if result.stdout:
            print(result.stdout)
        if result.stderr:
            print(result.stderr)
        return False
    
    print(f"✓ {description} passed")
    return True


def main():
    """Run all pre-commit checks."""
    print("=" * 60)
    print("Running pre-commit checks...")
    print("=" * 60)
    
    checks = [
        ("python scripts/verify-version.py", "Version consistency check"),
        ("pytest --maxfail=3 -q", "Quick test run"),
    ]
    
    # Optional checks (don't fail commit if these fail)
    optional_checks = [
        ("flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics", 
         "Critical syntax errors check"),
    ]
    
    all_passed = True
    
    # Run required checks
    for cmd, description in checks:
        if not run_command(cmd, description):
            all_passed = False
    
    # Run optional checks (warnings only)
    print("\nOptional checks (warnings only):")
    for cmd, description in optional_checks:
        if not run_command(cmd, description):
            print(f"⚠ {description} had warnings (not blocking commit)")
    
    print("=" * 60)
    
    if all_passed:
        print("✓ All pre-commit checks passed!")
        print("=" * 60)
        return 0
    else:
        print("❌ Some pre-commit checks failed!")
        print("Fix the issues above or use 'git commit --no-verify' to skip checks.")
        print("=" * 60)
        return 1


if __name__ == "__main__":
    sys.exit(main())
